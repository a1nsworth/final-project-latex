\RequirePackage{etoolbox}
\def\eskdrerun{}
\let\mysvdAtBeginDocument\AtBeginDocument
\makeatletter
\def\AtBeginDocument#1{
  {
        \mysvdAtBeginDocument{#1}
        \ifdefined\ESKD@frame@box
           \ifdefined\ESKDnewStyle
                \let\AtBeginDocument\mysvdAtBeginDocument
           \else\gappto\eskdrerun{#1}
           \fi
        \else
        \fi
  }
}

\documentclass[14pt, russian, utf8, simple, linethick=0.4mm, hpadding=10mm]{eskdtext}
\let\AtBeginDocument\mysvdAtBeginDocument

\input{packages.tex}
\input{preamble.tex}

% \makeatletter
%   \let\origsection\section
%
%   % Переопределяем \section так, чтобы оно разделяло *- и без*- варианты
%   \def\section{%
%     \@ifstar
%       {\secstar}%  вызов при \section*{…}
%       {\secnostar}% вызов при \section{…}
%   }
%
%   % Обычная (нумерованная) секция
%   \def\secnostar#1{%
%     \origsection{#1}%
%     \ESKDsignature{\normalfont\small #1}%
%     \eskdrerun
%   }
%
%   % Звёздная (ненумерованная) секция
%   \def\secstar#1{%
%     \origsection*{#1}%
%     \ESKDsignature{\normalfont\small #1}%
%     \eskdrerun
%   }
% \makeatother


\begin{document}
\counterwithin{lstlisting}{section}
\include{titlepage}
\tableofcontents

\include{sections/introduction}
\include{sections/description}
\include{sections/design}
\include{sections/implementation}
\include{sections/apendix}
\end{document}
